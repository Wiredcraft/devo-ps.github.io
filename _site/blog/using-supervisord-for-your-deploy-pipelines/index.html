<!doctype html>
<html>
<head>
  <meta charset='utf-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'/>

  <title>Using Supervisord for Your Deploy Pipelines | devo.ps</title>

  <meta http-equiv='Content-Language' content='en'/>
  <meta name='keywords' content='devo.ps, DevOps, Cloud, servers, git, API, infrastructure, automation, Continuous Integration, Continuous Deployment, Configuration Management, Orchestration, System Administration, PaaS, IaaS, supervisord, supervisor, deploy'/>
  <meta name='description' content='Dealing with servers doesn&#39;t have to be a pain: manage and automate all your servers with a few Git commands on any cloud, from Digital Ocean to AWS.'/>
  <meta name='msvalidate.01' content='86C1F235D57610586CFC5A2D77B7D446'/>
  <meta http-equiv='Content-Language' content='en'/>
  
  <!-- Favicons -->
  <link rel='shortcut icon' href='/assets/favicon.ico'>
<link rel='apple-touch-icon' sizes='57x57' href='/assets/favicons/apple-touch-icon-57x57.png'>
<link rel='apple-touch-icon' sizes='114x114' href='/assets/favicons/apple-touch-icon-114x114.png'>
<link rel='apple-touch-icon' sizes='72x72' href='/assets/favicons/apple-touch-icon-72x72.png'>
<link rel='apple-touch-icon' sizes='144x144' href='/assets/favicons/apple-touch-icon-144x144.png'>
<link rel='apple-touch-icon' sizes='60x60' href='/assets/favicons/apple-touch-icon-60x60.png'>
<link rel='apple-touch-icon' sizes='120x120' href='/assets/favicons/apple-touch-icon-120x120.png'>
<link rel='apple-touch-icon' sizes='76x76' href='/assets/favicons/apple-touch-icon-76x76.png'>
<link rel='apple-touch-icon' sizes='152x152' href='/assets/favicons/apple-touch-icon-152x152.png'>
<link rel='icon' type='image/png' href='/assets/favicons/favicon-196x196.png' sizes='196x196'>
<link rel='icon' type='image/png' href='/assets/favicons/favicon-160x160.png' sizes='160x160'>
<link rel='icon' type='image/png' href='/assets/favicons/favicon-96x96.png' sizes='96x96'>
<link rel='icon' type='image/png' href='/assets/favicons/favicon-16x16.png' sizes='16x16'>
<link rel='icon' type='image/png' href='/assets/favicons/favicon-32x32.png' sizes='32x32'>
<meta name='msapplication-TileColor' content='#da532c'>
<meta name='msapplication-TileImage' content='/assets/favicons/mstile-144x144.png'>
<meta name='msapplication-config' content='/assets/favicons/browserconfig.xml'>

  <!-- CSS -->
  <link href='/assets/styles.css?20140921' rel='stylesheet' type='text/css'/>
</head>
<body class='page-blog/using-supervisord-for-your-deploy-pipelines'>
  <header id='header'>
    <div class='wrapper'>
      <a href='/' class='logo'>devo.ps</a>

      <button class='toggle'>Menu</button>
      <nav class='menu'>
        <a href='https://www.hipchat.com/gyHEHtsXZ' target='_blank'>Chat with us</a>
        <a href='/pricing'>Pricing</a>
        <a href='http://app.devo.ps' class='signin'>Sign in</a>
      </nav>
    </div>
  </header>

  
<section id='main' class='blog post'>
  <div class='wrapper'>
    <header class='header'>
      <a href='/blog' class='back'><span>Back to the blog</span></a>

      <h1>Using Supervisord for Your Deploy Pipelines</h1>

      <span class='meta'>
        
        
        
        
        
        
        
        
        
        
          <img class='avatar' alt='Vincent Viallet' src='/images/team/vincent-small.png'/> 
          Vincent Viallet
        
        
        
        
        on <time datetime=''>October 21, 2014</time>
      </span>
    </header>

    <article class='content'>
      <p>Running programs automatically as service is not always an easy task. Some well known applications come with their own managers (e.g. unicorn, forever, pm2) but there is no unified approach across technologies.Custom build code often tend to come as a simple executable that runs in the foreground. And eventually init scripts simply ensure the services start but usually does not handle respawn.</p>
<p>Supervisord offers a solution to all the issues above and allows you to monitor and control processes. It lets you:</p>
<ul>
<li>starts / stop / manage processes (long or short running) via unix or http xml/rpc requests</li>
<li>automatically or manually start processes</li>
<li>easily restart crashed programs</li>
<li>manages log files and file rotation (conveniency)</li>
<li>easily manages running user</li>
<li>perfect for custom processes that are not managed as services</li>
<li>side benefit: play very well with docker containers</li>
</ul>
<p align='center'><img src="/images/posts/supervisord.png" alt="Supervisord"/></p>

<h2 id="using-supervisord-to-manage-deployments">Using Supervisord to manage deployments</h2>
<p>We&#39;re taking the mixed approach of running standalone commands and executing custom code as a service. Our example will be a deployement process.</p>
<p>A deployment may involve more that simply restart a service, but require to install dependency, etc.</p>
<p>When dealing with multiple servers, the deployment workflow may be different due to the various services involved; having supervisord doing some unified interface is extremely convenient.</p>
<h2 id="supervisord-setup">Supervisord setup</h2>
<p>Supervisord is often available within the package manager of your distrib (<code>apt-get install supervisor</code>), if not you should be able to install it via <code>pip</code> as well (<code>pip install supervisor</code>)</p>
<p>We&#39;re creating here a simple config file that will define 2 programs:</p>
<ul>
<li><code>deploy</code> that will not start automatically and will require to be executed manually (<code>autostart</code> option), </li>
<li><code>app</code> that is a random node.js application that will start automatically </li>
</ul>
<p>One can simply run <code>supervisorctl start deploy</code> and get the deploy process starting. Within the <code>deploy.sh</code>script, one can put any of the required logic needed to deploy the code</p>
<p>e.g. supervisord config in <code>/etc/supervisor/conf.d/my_app.conf</code></p>
<pre><code>[program:deploy]
command=/usr/local/bin/deploy.sh
autostart=false

[program:app]
command=/usr/bin/node main.js
directory=/opt/app
environment=&quot;NODE_ENV=prod&quot;
user=nobody
autostart=true
</code></pre><h2 id="deployment-script">Deployment script</h2>
<p>We&#39;re now preparing a simple script in <code>/usr/local/bin/deploy.sh</code> that will perform the operations required to deploy a new version of the code. Obviously this is only a sample! Be sure to set the execute flag or supervisord won&#39;t be able to execute it. (<code>chmod +x /usr/local/bin/deploy.sh</code>)</p>
<pre><code>#!/bin/bash
##################
# Simple deploy script for a node app
##################
WORKDIR=/opt/app
cd $WORKDIR

updated=$(git pull 2&gt;/dev/null)
if [ &quot;$updated&quot; == &#39;Already up-to-date.&#39; ]; then
    # Nothing to do, exit cleanly
    exit 0
else
    # Code has been updated, rebuild the app
    npm install
    ... other commands ...
    # And eventually restart the app
    supervisorctl restart app
fi
</code></pre><h2 id="enhancing-the-workflow-with-http-support-for-supervisord">Enhancing the workflow with HTTP support for supervisord</h2>
<p>The 2 code snippets above let you simply run the deployment operations and get the app restarted if necessary. But supervisord does not allow (yet) remote control.</p>
<p>This can then be very easily extended and triggered remotely by making use of the HTTP xml-rpc interface.</p>
<h2 id="enabling-http-xml-rpc">Enabling HTTP xml-rpc</h2>
<p>Add the following to your supervisord config (<code>/etc/supervisor/conf.d/inet.conf</code>)</p>
<pre><code>[inet_http_server]
port=*:9001
username=secret_user
password={SHA}secret_hash
</code></pre><p>Where the secret_hash is calculated as such <code>echo -n &#39;secret_pass&#39; | sha1sum | cut -f1 -d&#39; &#39;</code>. You need then to prefix this hash with <code>{SHA}</code> as explained <a href="http://supervisord.org/configuration.html#inet-http-server-section-values">http://supervisord.org/configuration.html#inet-http-server-section-values</a></p>
<p>Best practices still recommend that:</p>
<ol>
<li>you don&#39;t set the password in clear in the config</li>
<li>you protect your host via iptables and only allow selected hosts to reach the HTTP interface of supervisord</li>
</ol>
<h2 id="multi-host-support">Multi host support</h2>
<p>Now that Supervisord allows remote connections, you can orchestrate several boxes at once very simply. Obviously more logic is needed to play nice with the sequence, but you get the point...</p>
<pre><code>for host in host1 host2 host3; do
    supervisorctl -s http://$host:9001 -u secret_user -p secret_pass start deploy
done
</code></pre><p>And supervisor is now available in <a href="http://devo.ps">devo.ps</a>! Hurray</p>

      
      <footer class='share'>
        

<a class='email' href='mailto:?body=http%3A%2F%2Fdevo.ps%2Fblog%2Fusing-supervisord-for-your-deploy-pipelines'><span>Share by email</span></a>
<a class='facebook' target='_blank' href='https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fdevo.ps%2Fblog%2Fusing-supervisord-for-your-deploy-pipelines'><span>Share on facebook</span></a>
<a class='twitter' target='_blank' href='https://twitter.com/intent/tweet?text=@devo_ps%20&related=devo_ps&url=http%3A%2F%2Fdevo.ps%2Fblog%2Fusing-supervisord-for-your-deploy-pipelines'><span>Share on Twitter</span></a>
<a class='google' target='_blank' href='https://plus.google.com/share?url=http%3A%2F%2Fdevo.ps%2Fblog%2Fusing-supervisord-for-your-deploy-pipelines'><span>Share on Google+</span></a>
<a class='linkedin' target='_blank' href='http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fdevo.ps%2Fblog%2Fusing-supervisord-for-your-deploy-pipelines&title=Using%20Supervisord%20for%20Your%20Deploy%20Pipelines&source=devo.ps'><span>Share on LinkedIn</span></a>

      </footer>

      <footer class='subscribe'>
        <h2>Like what you just read?</h2>
        <p>Leave us your email address and we'll shoot you an email once in a while to share new content. We mostly write about development, infrastructure and DevOps.</p>
        <form action='http://wiredcraft.us2.list-manage1.com/subscribe/post?u=18eb8d6c34ad5d4e781541da9&amp;id=db875395f9' method='post' target='_blank'>
  <div class='field'>
    <input type='email' value='' name='EMAIL' class='required email' placeholder='Your email address'/>
  </div>
  <div class='field'>
    <input type='submit' value='Subscribe' name='subscribe' class='button'/>
  </div>
</form>
        <p>You can also <a href='http://feeds.feedburner.com/devo/BQLM' class='rss'>Subscribe to our RSS feed</a>.</p>
      </footer>

      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'devo-ps'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
  </div>
</section>


  <nav id='footer'>
    <div class='wrapper'>
      <nav class='product'>
        <h3>Product</h3>
        <a href='/#pricing'>Pricing</a>
        <a href='http://github.com/devops-community'>Community</a>
        <!-- <a href='/features'>Features</a> -->
      </nav>
      <nav class='help'>
        <h3>Help</h3>
        <a class='chat' href='https://www.hipchat.com/gyHEHtsXZ' target='_blank'>Chat with us</a>
        <a class='documentation' href='http://docs.devo.ps' target='_blank'>Documentation</a>
        <a class='help' href='mailto:help@devo.ps' target='_blank'>Support</a>
      </nav>
      <nav class='company'>
        <h3>Company</h3>
        <a href='/about'>About</a>
        <a href='/blog'>Blog</a>
        <a href='http://twitter.com/devo_ps' target='_blank'>Twitter</a>
      </nav>
      <aside class='subscribe'>
        <h3>Subscribe to our newsletter</h3>
        <form action='http://wiredcraft.us2.list-manage1.com/subscribe/post?u=18eb8d6c34ad5d4e781541da9&amp;id=db875395f9' method='post' target='_blank'>
  <div class='field'>
    <input type='email' value='' name='EMAIL' class='required email' placeholder='Your email address'/>
  </div>
  <div class='field'>
    <input type='submit' value='Subscribe' name='subscribe' class='button'/>
  </div>
</form>
      </aside>
      <small class='legal'>
        Copyright © 2014 Wiredcraft Co. Ltd. <a href='/privacy'>Privacy</a> <a href='/tos'>Terms of Service</a>
      </small>
    </div>
  </nav>

  <div id='overlay'>
    <div id='modal'></div>
  </div>

  <!-- JS -->
  <script src='/assets/scripts.js' type='text/javascript'></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <!--[if lt IE 9]><script src='http://html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->
  <script type='text/javascript'>
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '510b396a613f5d2666000007');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
	<script type='text/javascript'>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34006371-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
