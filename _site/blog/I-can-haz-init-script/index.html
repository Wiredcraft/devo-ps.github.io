<!doctype html>
<html>
<head>
  <meta charset='utf-8'/>
  <title>I Can Haz Init Script | devo.ps</title>
  
  
  <meta name='viewport' content='width=device-width, initial-scale=1'/>
  
  <!-- Favicons -->
  <link rel='shortcut icon' href='/assets/favicon.ico'>
  <link rel='apple-touch-icon' sizes='57x57' href='/assets/favicons/apple-touch-icon-57x57.png'>
  <link rel='apple-touch-icon' sizes='114x114' href='/assets/favicons/apple-touch-icon-114x114.png'>
  <link rel='apple-touch-icon' sizes='72x72' href='/assets/favicons/apple-touch-icon-72x72.png'>
  <link rel='apple-touch-icon' sizes='144x144' href='/assets/favicons/apple-touch-icon-144x144.png'>
  <link rel='apple-touch-icon' sizes='60x60' href='/assets/favicons/apple-touch-icon-60x60.png'>
  <link rel='apple-touch-icon' sizes='120x120' href='/assets/favicons/apple-touch-icon-120x120.png'>
  <link rel='apple-touch-icon' sizes='76x76' href='/assets/favicons/apple-touch-icon-76x76.png'>
  <link rel='apple-touch-icon' sizes='152x152' href='/assets/favicons/apple-touch-icon-152x152.png'>
  <link rel='icon' type='image/png' href='/assets/favicons/favicon-196x196.png' sizes='196x196'>
  <link rel='icon' type='image/png' href='/assets/favicons/favicon-160x160.png' sizes='160x160'>
  <link rel='icon' type='image/png' href='/assets/favicons/favicon-96x96.png' sizes='96x96'>
  <link rel='icon' type='image/png' href='/assets/favicons/favicon-16x16.png' sizes='16x16'>
  <link rel='icon' type='image/png' href='/assets/favicons/favicon-32x32.png' sizes='32x32'>
  <meta name='msapplication-TileColor' content='#da532c'>
  <meta name='msapplication-TileImage' content='/assets/favicons/mstile-144x144.png'>
  <meta name='msapplication-config' content='/assets/favicons/browserconfig.xml'>

  <!-- CSS -->
  <!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/> -->
  <link href='/assets/styles.css' rel='stylesheet' type='text/css'/>
</head>
<body>
  <header id='header'>
    <nav class='links'>
      <a href='/blog'>Blog</a>
      <a href='/about'>About</a>
    </nav>

    <a href='/' class='logo'>devo.ps</a>
  </header>

  <section id='main'>
    
<header class='header'>
  <nav class='links'>
    <div class='controls'>
      <a href='/blog' class='newsletter'><span>Subscribe to the newsletter</span></a>
      <a href='/newsletter' class='rss'><span>Subscribe to the RSS feed</span></a>
    </div>
    <a href='/blog' class='back'>← Back to the blog</a>
  </nav>

  <h1>I Can Haz Init Script</h1>

  <span class='meta'>
    
    
    
    
    
    
    
    
    
    
      <img class='avatar' alt='Vincent Viallet' src='/images/team/vincent-small.png'/> 
      Vincent Viallet
    
    
    
    
    on <time datetime=''>June 19, 2013</time>
  </span>
</header>

<article class='content post'>
  <p>Something went awfully wrong, and a rogue process is eating up all of the resources on one of your servers. You have no other choice but to restart it. No big deal, really; this is the age of disposable infrastructure after all. Except when it comes back up, everything starts going awry. Half the stuff supposed to be running is down and it&#39;s screwing with the rest of your setup.</p>
<p><img src="/images/posts/y-u-no-guy.png" alt="INIT SCRIPTS, Y U NO LIKE?"></p>
<p>You don&#39;t get to think about them very often, but init scripts are a key piece of a sound, scalable strategy for your infrastructure. It&#39;s a <a href="">mandatory best practice</a>. Period. And there are quite a few things in the way of getting them to work properly at scale in production environments. It&#39;s a tough world out there.</p>
<h3 id="what-we-re-dealing-with-">What we&#39;re dealing with...</h3>
<h4 id="packages">Packages</h4>
<p>Often enough, you&#39;re gonna end up installing a service using the package manager of your distro: <code>yum</code>, <code>apt-get</code>, you name it. These packages usually come with an init script that should get you started.</p>
<p>Sadly, as your architecture grows in complexity, you&#39;ll probably run into some walls. Wanna have multiple memcache buckets, or several instances of redis running on the same box? You&#39;re out of luck buddy. Time to hack your way through:</p>
<ul>
<li>Redefine your start logic, </li>
<li>Load one or multiple config files from <code>/etc/defaults</code> or <code>/etc/sysconfig</code>,</li>
<li>Deal with the PIDs, log and lock files,</li>
<li>Implement conditional logic to start/stop/restart one or more of the services,</li>
<li>Realize you&#39;ve messed something up,</li>
<li>Same player shoot again.</li>
</ul>
<p>Honestly: PITA.</p>
<h4 id="built-from-source">Built from source</h4>
<p>First things first: <strong>you shouldn&#39;t be building from source</strong> (unless you really, really need to).</p>
<p>Now if you do, you&#39;ll have to be thorough: there may be samples of init scripts in there, but you&#39;ll have to dig them out. <code>/contrib</code>, <code>/addons</code>, ... it&#39;s never in the same place.</p>
<p>And that makes things &quot;fun&quot; when you&#39;re <a href="http://devo.ps/blog/2013/03/06/troubleshooting-5minutes-on-a-yet-unknown-box.html">trying to unscrew things on a box</a>:</p>
<ul>
<li>You figured out that MySQL is running from <code>/home/user/src/mysql</code>,</li>
<li>You check if there&#39;s an init script: no luck this time...</li>
<li>You try to understand what exactly launched <code>mysqld_safe</code>,</li>
<li>You spend a while digging into the bash history smiling at typos,</li>
<li>You stumble on a <code>run.sh</code> script (uncommented, of course) in the home directory. Funny enough, it seems to be starting everything from MySQL, NGINX and php-fpm to the coffee maker.</li>
<li>You make a mental note to try and track down the &quot;genius&quot; who did that mess of a job, and get busy with converting everything to a proper init script.</li>
</ul>
<p>Great.</p>
<h3 id="why-existing-solutions-suck">Why existing solutions suck</h3>
<p>Well, based on what we&#39;ve just seen, you really only have two options:</p>
<ol>
<li><strong>DIY</strong>; but if you&#39;re good at what you do, you&#39;re probably also lazy. You may do it the first couple times, but that&#39;s not gonna scale, especially when dealing with the various flavors of init daemons (upstart, systemd...),</li>
<li><strong>Use that thing called &quot;the Internet&quot;</strong>; you read through forum pages, issue queues, gists and if you&#39;re lucky you&#39;ll find a perfect one (or more likely 10 sucky ones). Kudos to all those of whom shared their work, but you&#39;ll probably be back to option 1.</li>
</ol>
<h3 id="we-can-do-better-than-this">We can do better than this</h3>
<p>You&#39;ll find a gazillion websites for pictures of kittens, but as far as I know, there is no authoritative source for  init scripts. That&#39;s just not right: we have to fix it. A few things I&#39;m aiming for:</p>
<ul>
<li><strong>Scalable</strong>; allow for multiple instances of a service to be started at once from different config files (see the memcache/redis example),</li>
<li><strong>Secure</strong>; ensure <code>configtest</code> is run before a restart/reload (because, you know, a faulty config file preventing the service to restart is kind of a bummer),</li>
<li><strong>Smart</strong>; ensuring for example that the cache is aggressively flushed before restarting your database (so that you don&#39;t end-up waiting 50 min for the DB to cleanly shutdown).</li>
</ul>
<p><a href="https://github.com/devo-ps/init-scripts">I&#39;ve just created a repo</a> where I&#39;ll be dumping various init scripts that will hopefully be helpful to others. I&#39;d love to get suggestions or help.</p>
<p>And by the way, things are not much better with applications, though we&#39;re trying our best to improve things there too with things like <a href="https://github.com/Unitech/pm2">pm2</a> (fresh and shinny, more about it in a later post).</p>

  
  <ul class='card'>
    <li class='newsletter'>
      <h2>Stay tuned by email</h2>
      <form action='http://wiredcraft.us2.list-manage1.com/subscribe/post?u=18eb8d6c34ad5d4e781541da9&amp;id=db875395f9' method='post' target='_blank'>
  <div class='field'>
    <input type='email' value='' name='EMAIL' class='required email' placeholder='Your email address'/>
  </div>
  <div class='field'>
    <input type='submit' value='Subscribe to our newsletter' name='subscribe' class='button'/>
  </div>
</form>
    </li>
    <li class='feedback'>
      <h2>Have some feedback?</h2>
      <p>Let us know on <a href='https://twitter.com/intent/tweet?text=@devo_ps%20&related=devo_ps&url=http://devo.ps/blog/I-can-haz-init-script' target='_blank'>Twitter</a> or keep the discussion going on <a href='http://news.ycombinator.com/item?id=5905051' target='_blank'>Hacker News</a>.</p>
    </li>
  </ul>
</section>

  </section>

  <footer id='footer'>Copyright © devo.ps. All rights reserved.</footer>

  <!-- JS -->
  <!-- <script src='/assets/scripts.js' type='text/javascript'></script> -->
  <!--[if lt IE 9]><script src='http://html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->
  <!--  -->
	<!--  -->
</body>
</html>
