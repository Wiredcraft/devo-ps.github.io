<!DOCTYPE html>
<html>
<head>
  <title>devo.ps</title>
  <meta charset='utf-8'/>
  <meta name='description' content='Documentation website'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'/>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
  <link href='/assets/styles.css?v=1' rel='stylesheet' type='text/css'/>
  <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==
typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");for(g=0;g<i.length;g++)f(c,i[g]);
b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]);
mixpanel.init("7b7a659fc843818d4c523cde96863ef5");</script><!-- end Mixpanel -->
</head>
<body>
  <header id='header'>
    <div class='content'>
      <a href='/' id='home'><img src='/images/logo.png' alt='devo.ps'/></a>
      <nav>
        <ul>
          <li><a href='/blog'>Blog</a></li>
          <li><a href='http://app.devo.ps'>login</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <section id='content'>
    
<div class='content'>
  
<aside class='sidebar'>
    <p class='about sticky'>With devo.ps you can easily manage your own infrastructure: deploy servers in the cloud (AWS, Rackspace, Linode), add and configure services and automation. <a href='/''>Learn more</a></p>
    <p><a href='/atom.xml'>Subscribe to the RSS feed</a></p>
</aside>

<article class='main'>
  
<header class='back'><a href='/blog'>‹ Read other posts from the blog</a></header>

<article class='post'>
  <aside class='meta'>
    
    
    
    
    
    
    
    
    
    
    
    
    
  </aside>
  
  <h2>Code Reuse With Node.js</h2>
  
  <section>
    
    <p><img src="http://devo.ps/images/posts/recycle.png" alt="Code recycling"></p>
<p>Any project that grows to a decent size will need to re-use parts of its code extensively. That often means, through the development cycle, a fair amount of rewrites and refactoring exercises. Elegant code re-use is hard to pull off.</p>
<p>With node.js, which we use quite a bit at <a href="http://devo.ps">devo.ps</a>, the most common ways to do this often rely on prototype or class inheritance. The problem is, as the inheritance chain grows, managing attributes and functions can become quite complex.</p>
<p>The truth is, people usually just need the objects. This led us to adopt a certain form of object-based prototyping. We believe it to be leaner and more straightforward in most cases. But before we get there, let&#39;s have a look at how people usually approach this issue.</p>
<h2 id="the-function-copy-">The &quot;Function copy&quot;</h2>
<p>Usually in the form of <code>this[key] = that[key]</code>. A quick example:</p>
<pre><code>var objectA = {
    lorem: &#39;lorem ipsum&#39;
};
var objectB = {};

// Direct copy of a string, but you get the idea
objectB.lorem = objectA.lorem;
console.log(objectB); // Will output: { lorem: &#39;lorem ipsum&#39; }
</code></pre><p>Crude, but it works. Next...</p>
<h2 id="object-defineproperties-">Object.defineProperties()</h2>
<p>The previous method may work with simple structures, but it won&#39;t hold when your use cases become more complex. That&#39;s when I usually call my buddy <code>Object.defineProperties()</code>:</p>
<pre><code>var descriptor = Object.getOwnPropertyDescriptor;
var defineProp = Object.defineProperty;

var objectA = {};
var objectB = {};
var objectC = {};

objectA.__defineGetter__(&#39;lorem&#39;, function() {
    return &#39;lorem ipsum&#39;;
});
console.log(objectA); // Will output: { lorem: [Getter] }

// Direct copy, which copies the result of the getter.
objectB.lorem = objectA.lorem;
console.log(objectB); // Will output: { lorem: &#39;lorem ipsum&#39; }

// Copying with Object.defineProperty(), and it copies the getter itself.
defineProp(objectC, &#39;lorem&#39;, descriptor(objectA, &#39;lorem&#39;));
console.log(objectC); // Will output: { lorem: [Getter] }
</code></pre><p>I often use a library for that. A couple examples (more or less the same stuff with different coding styles):</p>
<ol>
<li><p><strong><a href="https://github.com/medikoo/es5-ext">es5-ext</a></strong></p>
<pre><code> var extend = require(&#39;es5-ext/lib/Object/extend-properties&#39;);

 var objectA = {};
 var objectC = {};

 objectA.__defineGetter__(&#39;lorem&#39;, function() {
     return &#39;lorem ipsum&#39;;
 });

 extend(objectC, objectA);
 console.log(objectC); // Will output: { lorem: [Getter] }
</code></pre></li>
<li><p><strong><a href="https://github.com/devo-ps/carcass">Carcass</a></strong></p>
<pre><code> var carcass = require(&#39;carcass&#39;);

 var objectA = {};
 var objectC = {};

 objectA.__defineGetter__(&#39;lorem&#39;, function() {
     return &#39;lorem ipsum&#39;;
 });

 carcass.mixable(objectC);
 objectC.mixin(objectA);
 console.log(objectC); // Will output: { mixin: [Function: mixin], lorem: [Getter] }
</code></pre></li>
</ol>
<p>Slightly better, but not optimal. Now, let&#39;s see what we end up doing more and more often:</p>
<h2 id="prototyping-through-objects">Prototyping through objects</h2>
<p>The basic idea is that we prepare some functions, wrap them into an object which then becomes a &quot;feature&quot;. That feature can then be re-used by simply merging it with the targeted structure (object or prototype).</p>
<p>Let&#39;s take the example of the <a href="https://github.com/devo-ps/carcass/blob/master/lib/proto/loaderSync.js">loaderSync</a> script in <a href="https://github.com/devo-ps/carcass">Carcass</a>:</p>
<pre><code>module.exports = {
    source: source,
    parser: parser,
    reload: reload,
    get: get
};

function get() {

(...)
</code></pre><p>Once you copy the functions to an object, this object becomes a &quot;loader&quot; that can load a &quot;source&quot; synchronously with a &quot;parser&quot;. A &quot;source&quot; can be a file path and the &quot;parser&quot; can be simply Node.js&#39; <code>require</code> function.</p>
<p>Let&#39;s now see how to use this with a couple object builders. Once again, I&#39;ll borrow an example from Carcass; the <a href="https://github.com/devo-ps/carcass/blob/master/benchmark/proto.loaderSync.js">loaderSync benchmark script</a>. The first builder generates a function and copies the methods from what we&#39;ve prepared. The second one copies the methods to the prototype of a builder class:</p>
<pre><code>(...)

function LoaderA(_source) {
    function loader() {
        return loader.get();
    }
    loader.mixin = mixin;
    loader.mixin(loaderSync);
    loader.source(_source);
    return loader;
}

(...)

function LoaderC(_source) {
    if (!(this instanceof LoaderC)) return new LoaderC(_source);
    this.source(_source);
}
LoaderC.prototype.mixin = mixin;
LoaderC.prototype.mixin(loaderSync);

(...)
</code></pre><p>Here we can see the two approaches. Let&#39;s compare them quickly:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Loader A</th>
<th>Loader C</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Instantiating</strong></td>
<td><code>var a = LoaderA(...)</code></td>
<td><code>var c = LoaderC(...)</code> or <code>var c = new LoaderC(...)</code></td>
</tr>
<tr>
<td><strong>Appearance</strong></td>
<td>Generates a function</td>
<td>Builds a typical instance which is an object.</td>
</tr>
<tr>
<td><strong>Invoking directly</strong></td>
<td><code>a()</code> or <code>a.get()</code></td>
<td><code>c.get()</code></td>
</tr>
<tr>
<td><strong>Invoking as a callback</strong></td>
<td><code>ipsum(a)</code></td>
<td><code>ipsum(c.get.bind(c))</code></td>
</tr>
<tr>
<td><strong>Performance <sup>†</sup> of instantiating</strong></td>
<td>-</td>
<td>100x faster</td>
</tr>
<tr>
<td><strong>Performance of invoking</strong></td>
<td><em>idem</em></td>
<td><em>idem</em></td>
</tr>
</tbody>
</table>
<p><strong>†</strong>: (check it yourself by <a href="https://github.com/devo-ps/carcass/blob/master/Makefile">benchmarking Carcass with <code>make bm</code></a>)</p>
<h3 id="-protos-and-beyond">&quot;Protos&quot; and beyond</h3>
<p>That last approach is gaining traction among our team; we prepare functions for our object builders (which, by the way, we call &quot;protos&quot;). While we still choose to use prototypes in some occurrences, it is mainly because it is faster to get done. For the sake of convenience, we also sometimes rely on functions rather than objects to invoke our &quot;protos&quot;, however keep in mind that this is a performance trade-off.</p>
<p>I&#39;ll wrap this up mentioning one more method we use, admittedly less often: &quot;Object alter&quot;. The idea is to rely on an &quot;alter&quot; function designed to change objects passed to it. This is sometimes also called a &quot;mixin&quot;. An example from <a href="https://github.com/visionmedia/configurable.js">vsionmedia&#39;s trove of awesomeness on Github</a>:</p>
<pre><code>(...)

module.exports = function(obj){

    obj.settings = {};

    obj.set = function(name, val){
        (...)
    };

    (...)

    return obj;
};
</code></pre><h3 id="resources">Resources</h3>
<ul>
<li><a href="http://killdream.github.io/2011/10/09/understanding-javascript-oop.html">A case for prototypes</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">MDN Object reference</a></li>
</ul>

    
  </section>
    
  <ul class='sticky'>
    <li>Have some feedback? <a href='https://twitter.com/intent/tweet?text=@devo_ps%20&related=devo_ps&url=http://devo.ps/2013/07/11/code-reuse-with-node-js' target='_blank'>Let us know on Twitter</a>.</li>
    
  </ul>
</article>

</article>

</div>

  </section>
  <footer id='footer'>
    <div class='content'>
      <div class='newsletter'><form action='http://wiredcraft.us2.list-manage1.com/subscribe/post?u=18eb8d6c34ad5d4e781541da9&amp;id=db875395f9' method='post' target='_blank'>
  <div class='field'>
    <input type='email' value='' name='EMAIL' class='required email' placeholder='Your email address'/>
  </div>
  <div class='field'>
    <input type='submit' value='Sign up for an invite' name='subscribe' class='button'/>
  </div>
</form></div>
      <ul class='links'>
  <li><a href='/about'>About</a></li>
  <li><a href='/blog'>Blog</a></li>
</ul>

      <div class='copyright'>Copyright © devo.ps. All rights reserved.</div>
    </section>
  </footer>
  
  <!-- JS -->
  <script src='/assets/scripts.js' type='text/javascript'></script>
  <!--[if lt IE 9]><script src='http://html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->
  <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '510b396a613f5d2666000007');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
	<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34006371-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>