<!DOCTYPE html>
<html>
<head>
  <title>devo.ps</title>
  <meta charset='utf-8'/>
  <meta name='description' content='Documentation website'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'/>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
  <link href='/assets/styles.css?v=1' rel='stylesheet' type='text/css'/>
  <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==
typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");for(g=0;g<i.length;g++)f(c,i[g]);
b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]);
mixpanel.init("7b7a659fc843818d4c523cde96863ef5");</script><!-- end Mixpanel -->
</head>
<body>
  <header id='header'>
    <div class='content'>
      <a href='/' id='home'><img src='/images/logo.png' alt='devo.ps'/></a>
      <nav>
        <ul>
          <li><a href='/blog'>Blog</a></li>
          <li><a href='http://app.devo.ps'>login</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <section id='content'>
    
<div class='content'>
  
<aside class='sidebar'>
    <p class='about sticky'>With devo.ps you can easily manage your own infrastructure: deploy servers in the cloud (AWS, Rackspace, Linode), add and configure services and automation. <a href='/''>Learn more</a></p>
    <p><a href='/atom.xml'>Subscribe to the RSS feed</a></p>
</aside>

<article class='main'>
  
<header class='back'><a href='/blog'>‹ Read other posts from the blog</a></header>

<article class='post'>
  <aside class='meta'>
    
    
    
    
    
    
    
    
    
    
    
    
    
  </aside>
  
  <h2>Goodbye node-forever, hello PM2</h2>
  
  <section>
    
    <p><img src="http://apps.hemca.com/pm2/pres/pm22.png" alt="pm2 logo"></p>
<p>It&#39;s no secret that the devo.ps team has a crush on Javascript; node.js in the backend, AngularJS for our clients, there isn&#39;t much of our stack that isn&#39;t at least in part built with it. Our approach of building <a href="http://devo.ps/blog/2013/01/31/farewell-to-regular-web-development-approaches.html">static clients and RESTful JSON APIs</a> means that we run a lot of node.js and I must admit that, despite all of it awesomeness, node.js still is a bit of a headache when it comes to running in production. Tooling and best practices (think monitoring, logging, error traces...) are still lacking when compared to some of the more established languages.</p>
<p>So far, we had been relying on the pretty nifty <a href="https://github.com/nodejitsu/forever">node-forever</a>. Great tool, but a few things were missing:</p>
<ul>
<li>Limited monitoring and logging abilities,</li>
<li>Poor support for process management configuration,</li>
<li>No support for clusterization,</li>
<li>Aging codebase (which meant frequent failures when upgrading Node).</li>
</ul>
<p>This is what led us to write <a href="https://github.com/Unitech/pm2">PM2</a> in the past couple months. We thought we&#39;d give you a quick look at it while we&#39;re nearing a production ready release.</p>
<h3 id="so-what-s-in-the-box-">So what&#39;s in the box?</h3>
<p>First things first, you can install it with <code>npm</code>:</p>
<pre><code>npm install -g pm2
</code></pre><p>Let&#39;s open things up with the usual comparison table:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th style="text-align:center">Forever</th>
<th style="text-align:center">PM2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Keep Alive</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
<tr>
<td>Coffeescript</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
<tr>
<td>Log aggregation</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
<tr>
<td>API</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
<tr>
<td>Terminal monitoring</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
<tr>
<td>Clustering</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
<tr>
<td>JSON configuration</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td></td>
</tr>
</tbody>
</table>
<p>And now let me geek a tad more about the main features...</p>
<h3 id="native-clusterization">Native clusterization</h3>
<p>Node v0.6 introduced the cluster feature, allowing you to share a socket across multiple networked Node applications. Problem is, it doesn&#39;t work out of the box and requires some tweaking to handle master and children processes.</p>
<p>PM2 handles this natively, without any extra code: PM2 itself will act as the master process and wrap your code into a special clustered process, as Nodejs does, to add some global variables to your files.</p>
<p>To start a clustered app using all the CPUs you just need to type something like that:</p>
<pre><code>$ pm2 start app.js -i max
</code></pre><p>Then;</p>
<pre><code>$ pm2 list
</code></pre><p>Which should display something like (ASCII UI FTW);</p>
<p><img src="http://apps.hemca.com/pm2/pres/pm2-list.png" alt="pm2 list"></p>
<p>As you can see, your app is now forked into multiple processes depending on the number of CPUs available.</p>
<h3 id="monitoring-a-la-termcaps-htop">Monitoring <em>a la</em> termcaps-HTOP</h3>
<p>It&#39;s nice enough to have an overview of the running processes and their status with the <code>pm2 list</code> command. But what about tracking their resources consumption? Fear not:</p>
<pre><code>$ pm2 monit
</code></pre><p>You should get the CPU usage and memory consumption by process (and cluster).</p>
<p><img src="http://apps.hemca.com/pm2/pres/pm2-monit.png" alt="pm2 monit"></p>
<p><strong>Disclaimer</strong>: <a href="https://github.com/arunoda/node-usage">node-usage</a> doesn&#39;t support MacOS for now (feel free to PR). It works just fine on Linux though.</p>
<p>Now, what about checking on our clusters and GC cleaning of the memory stack? Let&#39;s consider you already have an HTTP benchmark tool (if not, you should definitely check <a href="https://github.com/wg/wrk">WRK</a>):</p>
<pre><code>$ express bufallo     // Create an express app
$ cd bufallo
$ npm install
$ pm2 start app.js -i max
$ wrk -c 100 -d 100 http://localhost:3000/
</code></pre><p>In another terminal, launch the monitoring option:</p>
<pre><code>$ pm2 monit
</code></pre><p>W00t!</p>
<h3 id="realtime-log-aggregation">Realtime log aggregation</h3>
<p>Now you have to manage multiple clustered processes: one who&#39;s crawling data, another who is processing stuff, and so on so forth. That means logs, lots of it. You can still handle it the old fashioned way:</p>
<pre><code>$ tail -f /path/to/log1 /path/to/log2 ...
</code></pre><p>But we&#39;re nice, so we wrote the <code>logs</code> feature:</p>
<pre><code>$ pm2 logs
</code></pre><p><img src="http://apps.hemca.com/pm2/pres/pm2-logs.png" alt="pm2 monit"></p>
<h3 id="resurrection">Resurrection</h3>
<p>So things are nice and dandy, your processes are humming and you need to do a hard restart. What now? Well, first, dump things:</p>
<pre><code>$ pm2 dump
</code></pre><p>From there, you should be able to resurrect things from file:</p>
<pre><code>$ pm2 kill     // let&#39;s simulate a pm2 stop
$ pm2 resurect // All my processes are now up and running 
</code></pre><h3 id="api-health-point">API Health point</h3>
<p>Let&#39;s say you want to monitor all the processes managed by PM2, as well as the status of the machine they run on (and maybe even build a nice Angular app to consume this API...):</p>
<pre><code>$ pm2 web
</code></pre><p>Point your browser at <code>http://localhost:9615</code>, aaaaand... done!</p>
<h3 id="and-there-s-more-">And there&#39;s more...</h3>
<ul>
<li>Full tests,</li>
<li>Generation of <code>update-rc.d</code> (<code>pm2 startup</code>), though still very alpha,</li>
<li>Development mode with auto restart on file change (<code>pm2 dev</code>), still very drafty too,</li>
<li>Log flushing,</li>
<li>Management of your applications fleet via JSON file,</li>
<li>Log uncaught exceptions in error logs,</li>
<li>Log of restart count and time,</li>
<li>Automated killing of processes exiting too fast.</li>
</ul>
<h3 id="what-s-next-">What&#39;s next?</h3>
<p>Well first, you could show your love on Github (we love stars): <a href="https://github.com/Unitech/pm2">https://github.com/Unitech/pm2</a>.</p>
<p>We developed PM2 to offer an advanced and complete solution for Node process management. We&#39;re looking forward to getting more people helping us getting there: pull requests are more than welcome. A few things already on the roadmap that we&#39;ll get right at once we have a stable core:</p>
<ul>
<li>Remote administration/status checking,</li>
<li>Built-in inter-processes communication channel (message bus),</li>
<li>V8 GC memory leak detection,</li>
<li>Web interface,</li>
<li>Persistent storage for monitoring data,</li>
<li>Email notifications.</li>
</ul>
<p>Special thanks to <a href="https://github.com/makara">Makara Wang</a> for concepts/tools and <a href="https://github.com/rlidwka">Alex Kocharin</a> for advices and pull requests.</p>

    
  </section>
    
  <ul class='sticky'>
    <li>Have some feedback? <a href='https://twitter.com/intent/tweet?text=@devo_ps%20&related=devo_ps&url=http://devo.ps/2013/06/26/goodbye-node-forever-hello-pm2' target='_blank'>Let us know on Twitter</a>.</li>
    <li>Keep the discussion going on <a href='http://news.ycombinator.com/item?id=5945420' target='_blank'>Hacker News</a>.</li>
  </ul>
</article>

</article>

</div>

  </section>
  <footer id='footer'>
    <div class='content'>
      <div class='newsletter'><form action='http://wiredcraft.us2.list-manage1.com/subscribe/post?u=18eb8d6c34ad5d4e781541da9&amp;id=db875395f9' method='post' target='_blank'>
  <div class='field'>
    <input type='email' value='' name='EMAIL' class='required email' placeholder='Your email address'/>
  </div>
  <div class='field'>
    <input type='submit' value='Sign up for an invite' name='subscribe' class='button'/>
  </div>
</form></div>
      <ul class='links'>
  <li><a href='/about'>About</a></li>
  <li><a href='/blog'>Blog</a></li>
</ul>

      <div class='copyright'>Copyright © devo.ps. All rights reserved.</div>
    </section>
  </footer>
  
  <!-- JS -->
  <script src='/assets/scripts.js' type='text/javascript'></script>
  <!--[if lt IE 9]><script src='http://html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->
  <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '510b396a613f5d2666000007');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
	<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34006371-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>